<!DOCTYPE html>
<html lang="es" data-theme="classic">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dise√±ador de Libros Digitales PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --footer-height: 34px;
            --page-width: 45vw;
        }

        [data-theme="classic"] {
            --bg-color: #333;
            --book-bg: #fdfaf3;
            --text-color: #3d352a;
            --primary-color: #6b4f3a;
            --secondary-color: #dcd5c9;
            --button-bg: #8c7862;
            --button-hover-bg: #6b5b4a;
            --subtle-bg: #f5f2eb;
        }

        [data-theme="dusk"] {
            --bg-color: #2c3e50;
            --book-bg: #ecf0f1;
            --text-color: #34495e;
            --primary-color: #8e44ad;
            --secondary-color: #bdc3c7;
            --button-bg: #9b59b6;
            --button-hover-bg: #8e44ad;
            --subtle-bg: #e4e7ea;
        }

        [data-theme="ocean"] {
            --bg-color: #1a2a47;
            --book-bg: #f0f4f8;
            --text-color: #2c3e50;
            --primary-color: #2980b9;
            --secondary-color: #a9cce3;
            --button-bg: #3498db;
            --button-hover-bg: #2980b9;
            --subtle-bg: #e1eaf2;
        }

        [data-theme="forest"] {
            --bg-color: #2d3a3a;
            --book-bg: #f5f5f5;
            --text-color: #3e4444;
            --primary-color: #27ae60;
            --secondary-color: #bad4c1;
            --button-bg: #2ecc71;
            --button-hover-bg: #27ae60;
            --subtle-bg: #e8f6ef;
        }

        [data-theme="manuscript"] {
            --bg-color: #4a3b31;
            --book-bg: #fbf5e7;
            --text-color: #5d4037;
            --primary-color: #c0392b;
            --secondary-color: #e6b8af;
            --button-bg: #e74c3c;
            --button-hover-bg: #c0392b;
            --subtle-bg: #faeee7;
        }

        [data-theme="wine"] {
            --bg-color: #2c001e;
            --book-bg: #fff0f5;
            --text-color: #5d1d4d;
            --primary-color: #9d2d5d;
            --secondary-color: #f7d9e8;
            --button-bg: #c7386f;
            --button-hover-bg: #9d2d5d;
            --subtle-bg: #ffeef7;
        }

        [data-theme="retro"] {
            --bg-color: #3d3d3d;
            --book-bg: #fefbe9;
            --text-color: #4c4c4c;
            --primary-color: #fca311;
            --secondary-color: #e5e5e5;
            --button-bg: #fca311;
            --button-hover-bg: #e8950d;
            --subtle-bg: #fffde7;
        }

        [data-theme="graphite"] {
            --bg-color: #121212;
            --book-bg: #f9f9f9;
            --text-color: #222222;
            --primary-color: #007bff;
            --secondary-color: #dee2e6;
            --button-bg: #007bff;
            --button-hover-bg: #0056b3;
            --subtle-bg: #f0f2f5;
        }

        [data-theme="earth"] {
            --bg-color: #5c4d42;
            --book-bg: #f7f3e9;
            --text-color: #5d4037;
            --primary-color: #8d6e63;
            --secondary-color: #d7ccc8;
            --button-bg: #a1887f;
            --button-hover-bg: #8d6e63;
            --subtle-bg: #efebe9;
        }

        [data-theme="neon-night"] {
            --bg-color: #0d0221;
            --book-bg: #f0f0f5;
            --text-color: #2e0249;
            --primary-color: #f800e3;
            --secondary-color: #c792ea;
            --button-bg: #f800e3;
            --button-hover-bg: #c700b5;
            --subtle-bg: #f5e6ff;
        }

        body {
            font-family: 'Georgia', serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #config-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            text-align: center;
            padding: 40px 20px;
            background-color: var(--book-bg);
            box-sizing: border-box;
        }

        #config-container h1 {
            color: var(--primary-color);
            font-size: 2.8em;
        }

        #config-container p {
            font-size: 1.1em;
            max-width: 700px;
            line-height: 1.5;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 900px;
            margin: 20px 0;
        }

        .input-group {
            text-align: left;
        }

        .input-group.full-width {
            grid-column: 1 / -1;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--primary-color);
        }

        #book-title-input,
        select,
        .chapter-title-input {
            font-family: 'Georgia', serif;
            font-size: 1.1em;
            padding: 10px;
            width: 100%;
            border: 2px solid var(--secondary-color);
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #fff;
            color: #333;
        }

        #api-key-input {
            font-family: 'Georgia', serif;
            font-size: 1.1em;
            padding: 10px;
            width: 100%;
            border: 2px solid var(--secondary-color);
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #fff;
            color: #333;
        }

        #get-api-key-btn:hover {
            background-color: var(--button-hover-bg);
            transition: background-color 0.3s;
        }

        #chapter-titles-container {
            padding-top: 20px;
            margin-top: 15px;
            border-top: 2px solid var(--secondary-color);
        }

        #generate-btn {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            grid-column: 1 / -1;
        }

        #generate-btn:hover {
            background-color: var(--button-hover-bg);
        }

        #loader {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            background-color: var(--book-bg);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 200;
        }

        .spinner {
            border: 8px solid var(--secondary-color);
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
        }

        #loading-status {
            margin-top: 20px;
            font-size: 1.2em;
            color: var(--primary-color);
            max-width: 80%;
            text-align: center;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #book-wrapper {
            width: 100%;
            height: calc(100vh - var(--footer-height));
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #book-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        nav {
            padding: 8px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: calc(var(--page-width) * 2 + 4px);
            box-sizing: border-box;
            flex-shrink: 0;
        }

        nav .nav-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        nav button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        nav button:hover {
            background-color: var(--button-hover-bg);
        }

        nav button:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        #page-input {
            width: 60px;
            padding: 7px;
            border-radius: 3px;
            border: 1px solid #555;
            background-color: #fdfaf3;
            color: #333;
            text-align: center;
        }

        #goto-btn {
            padding: 8px 12px;
        }

        .book {
            display: flex;
            width: calc(var(--page-width) * 2 + 4px);
            height: 78vh;
        }

        .spread {
            display: none;
            width: 100%;
            height: 100%;
        }

        .spread.active {
            display: flex;
        }

        .page {
            background-color: var(--book-bg);
            width: var(--page-width);
            height: 100%;
            border: 1px solid var(--secondary-color);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }

        .page-content {
            padding: 2.5em;
            box-sizing: border-box;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            color: var(--text-color);
        }

        .page.left {
            border-right: 2px solid var(--secondary-color);
        }

        .page.right {
            border-left: 2px solid var(--secondary-color);
        }

        .page-content h1,
        .page-content h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-top: 0;
            font-size: 2.2em;
        }

        .page-content h1 {
            font-size: 2.8em;
            text-align: center;
        }

        .page-content p {
            text-align: justify;
            line-height: 1.7;
        }

        .cover {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .cover .image-container {
            flex-shrink: 0;
            align-self: stretch;
            width: 100% !important;
        }

        .page.blank {
            background-color: var(--secondary-color);
            opacity: 0.5;
        }

        .info-box {
            margin: 1.5em 0;
            padding: 15px;
            border-radius: 5px;
        }

        .info-box h3 {
            margin: 0 0 10px 0;
            font-family: 'Cormorant Garamond', serif;
        }

        .info-box p {
            margin: 0;
            font-size: 1em;
            line-height: 1.5;
        }

        .info-box-style-1 {
            background-color: var(--subtle-bg);
            border-left: 4px solid var(--primary-color);
        }

        .info-box-style-1 h3 {
            color: var(--primary-color);
        }

        .info-box-style-2 {
            background-color: transparent;
            border: 1px solid var(--secondary-color);
            border-left-width: 3px;
            border-left-color: var(--primary-color);
        }

        .info-box-style-2 h3 {
            color: var(--primary-color);
        }

        .info-box-style-3 {
            background-color: var(--primary-color);
            color: var(--book-bg);
        }

        .info-box-style-3 h3 {
            color: var(--book-bg);
            border-bottom: 1px solid var(--secondary-color);
            padding-bottom: 8px;
        }

        .info-box-style-4 {
            background-color: var(--subtle-bg);
            border: 1px dashed var(--secondary-color);
        }

        .info-box-style-4 h3 {
            color: var(--primary-color);
            text-align: center;
        }

        .info-box-style-5 {
            background-color: transparent;
            border-top: 2px solid var(--secondary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-top: 20px;
            padding-bottom: 20px;
        }

        .info-box-style-5 h3 {
            color: var(--primary-color);
        }

        .info-box-style-6 {
            border: 2px solid var(--secondary-color);
            padding: 20px;
            text-align: center;
        }

        .info-box-style-6 h3 {
            color: var(--primary-color);
        }

        .info-box-style-7 {
            background-color: var(--subtle-bg);
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.1);
            border-top: 5px solid var(--primary-color);
        }

        .info-box-style-7 h3 {
            color: var(--primary-color);
        }

        .info-box-style-8 {
            border-left: 10px solid var(--secondary-color);
            padding-left: 25px;
        }

        .info-box-style-8 h3 {
            color: var(--primary-color);
        }

        .info-box-style-9 {
            background-color: var(--book-bg);
            position: relative;
            padding: 25px;
            margin-top: 30px;
            border: 1px solid var(--secondary-color);
        }

        .info-box-style-9 h3 {
            background-color: var(--primary-color);
            color: var(--book-bg);
            padding: 5px 10px;
            position: absolute;
            top: -15px;
            left: 10px;
        }

        .info-box-style-10 {
            background: repeating-linear-gradient(45deg, var(--book-bg), var(--book-bg) 10px, var(--subtle-bg) 10px, var(--subtle-bg) 20px);
            border: 1px solid var(--secondary-color);
        }

        .info-box-style-10 h3 {
            color: var(--primary-color);
        }

        .image-container {
            margin: 1em 0;
            position: relative;
            width: 100%;
            aspect-ratio: 800 / 400;
            transition: aspect-ratio 0.3s ease-in-out, height 0.3s ease-in-out;
            isolation: isolate;
            min-height: 200px;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            border: 1px solid var(--secondary-color);
            border-radius: 5px;
            object-fit: cover;
            transition: opacity 0.3s;
        }

        .image-container figcaption {
            text-align: center;
            font-style: italic;
            font-size: 0.9em;
            color: var(--primary-color);
            padding: 8px 5px 0 5px;
        }

        .image-controls {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .prompt-input {
            flex-grow: 1;
            font-family: monospace;
            font-size: 0.9em;
            padding: 5px;
            border: 1px solid var(--secondary-color);
            border-radius: 3px;
        }

        .regenerate-btn,
        .delete-btn,
        .youtube-btn,
        .odysee-btn,
        .url-image-btn {
            font-size: 0.9em;
            padding: 5px 10px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .regenerate-btn:hover,
        .delete-btn:hover,
        .youtube-btn:hover,
        .odysee-btn:hover,
        .url-image-btn:hover {
            background-color: var(--button-hover-bg);
        }

        .delete-btn {
            background-color: #c0392b;
        }

        .delete-btn:hover {
            background-color: #a02d22;
        }

        .youtube-btn {
            background-color: #c4302b;
        }

        .youtube-btn:hover {
            background-color: #a3221e;
        }

        .odysee-btn {
            background-color: #1a73e8;
        }

        .odysee-btn:hover {
            background-color: #1557b0;
        }

        .url-image-btn {
            background-color: #28a745;
        }

        .url-image-btn:hover {
            background-color: #218838;
        }

        .image-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .image-resizer {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            opacity: 0.2;
            transition: opacity 0.3s;
            z-index: 10;
        }

        .image-container:hover .image-resizer {
            opacity: 1;
        }

        .resize-btn {
            width: 24px;
            height: 24px;
            font-size: 16px;
            line-height: 24px;
            text-align: center;
            padding: 0;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            cursor: pointer;
        }

        .resize-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        footer {
            width: 100%;
            background-color: #222;
            color: #ccc;
            text-align: center;
            padding: 8px 0;
            font-size: 12px;
            z-index: 300;
            height: var(--footer-height);
            box-sizing: border-box;
            position: fixed;
            bottom: 0;
        }

        @media (orientation: portrait) {
            :root {
                --page-width: 90vw;
            }

            .book,
            nav {
                width: var(--page-width);
            }

            .page {
                width: 100%;
            }

            .page.left,
            .page.right {
                border: 1px solid var(--secondary-color);
            }

            #goto-group {
                display: none;
            }

            #top-nav {
                justify-content: space-between;
            }

            #top-nav .nav-group {
                flex-grow: 1;
            }

            #top-nav .nav-group:nth-child(2) {
                justify-content: center;
            }

            #top-nav .nav-group:last-child {
                justify-content: flex-end;
            }

            .spread.active {
                display: block;
                position: relative;
            }

            .spread .page {
                display: none;
            }

            .spread.active .page.left {
                display: block;
            }

            .spread.active.show-right .page.left {
                display: none;
            }

            .spread.active.show-right .page.right {
                display: block;
            }
        }
    </style>
</head>

<body>

    <div id="config-container">
        <h1 data-key="appName">Dise√±ador de Libros Digitales PRO</h1>
        <p data-key="appDescription">Elige un tema, idioma, modelo de IA, paleta de colores y estilo visual. La IA
            escribir√°, ilustrar√° y maquetar√° un libro completo para ti.</p>
        <div class="config-grid">
            <div class="input-group full-width">
                <label for="api-key-input" data-key="apiKeyLabel">API Key de Pollinations</label>
                <div style="display: flex; gap: 10px;">
                    <input type="password" id="api-key-input" data-key="apiKeyPlaceholder" placeholder="plln_sk_..."
                        style="flex: 1;">
                    <button id="get-api-key-btn" data-key="getApiKeyButton"
                        style="background-color: var(--button-bg); color: white; border: none; padding: 10px 20px; font-size: 1em; cursor: pointer; border-radius: 5px; white-space: nowrap;">üîë
                        Obtener API Key</button>
                </div>
            </div>
            <div class="input-group full-width"><label for="book-title-input" data-key="bookTitleLabel">T√≠tulo del
                    Libro</label><input type="text" id="book-title-input" data-key="bookTitlePlaceholder"
                    placeholder="Ej: La historia de los videojuegos"></div>
            <div class="input-group"><label for="chapter-count-selector" data-key="chapterCountLabel">N√∫mero de
                    Cap√≠tulos</label><select id="chapter-count-selector">
                    <option value="3">3</option>
                    <option value="4" selected>4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                </select></div>
            <div class="input-group"><label for="language-selector" data-key="languageLabel">Idioma</label><select
                    id="language-selector">
                    <option value="es">Espa√±ol</option>
                    <option value="en">English</option>
                </select></div>
            <div class="input-group"><label for="model-selector" data-key="modelTextLabel">Modelo de
                    Texto</label><select id="model-selector">
                    <option value="gemini-search">Gemini 2.5 (Google Search)</option>

                    <option value="openai">GPT-5 Nano</option>

                    <option value="openai-large">GPT-4.1</option>

                    <option value="mistral">Mistral Small 3.2 24B</option>

                    <option value="openai-reasoning"> OpenAI o4 Mini</option>

                    <option value="gemini">Gemini 2.5 Flash</option>

                    <option value="deepseek">DeepSeek V3.1</option>

                    <option value="grok">xAI Grok 4</option>

                    <option value="claude">Claude Haiku 4.5</option>

                    <option value="claude-large">Claude Sonnet 4.5</option>

                    <option value="perplexity-fast">Perplexity Sonar</option>

                    <option value="perplexity-reasoning">Perplexity Sonar Reasoning</option>

                    <option value="kimi-k2-thinking">Kimi K2 </option>

                    <option value="gemini-large">Gemini 3 Pro </option>

                </select></div>
            <div class="input-group"><label for="image-model-selector" data-key="modelImageLabel">Modelo de
                    Imagen</label><select id="image-model-selector">
                    <option value="flux" selected>Flux</option>
                    <option value="zimage">Z Image</button>
                    <option value="kontext">Flux kontext</option>
                    <option value="gptimage">GPT Image</option>

                    <option value="nanobanana">Nano Banana</option>
                    <option value="seedream">Seedream</option>
                    <option value="nanobanana-pro">Nano Banana Pro</option>
                    <option value="seedream-pro">Seedream 4.5 Pro</option>
                </select></div>
            <div class="input-group"><label for="palette-selector" data-key="paletteLabel">Paleta de
                    Colores</label><select id="palette-selector">
                    <option value="classic" selected></option>
                    <option value="dusk"></option>
                    <option value="ocean"></option>
                    <option value="forest"></option>
                    <option value="manuscript"></option>
                    <option value="wine"></option>
                    <option value="retro"></option>
                    <option value="graphite"></option>
                    <option value="earth"></option>
                    <option value="neon-night"></option>
                </select></div>
            <div class="input-group"><label for="style-selector" data-key="artStyleLabel">Estilo
                    Art√≠stico</label><select id="style-selector">
                    <option>Photographic</option>
                    <option>Anime</option>
                    <option>3D Cartoon</option>
                    <option>Illustration</option>
                    <option>Realism</option>
                    <option>Oil painting</option>
                    <option>Watercolor</option>
                    <option>Pencil sketch</option>
                    <option>Pop Art</option>
                    <option>Surrealism</option>
                    <option>Cyberpunk</option>
                    <option>Steampunk</option>
                    <option>Fantasy art</option>
                    <option>Vintage</option>
                    <option>Minimalist</option>
                    <option>Abstract</option>
                    <option>Impressionism</option>
                    <option>Art Nouveau</option>
                    <option>Gothic</option>
                    <option>Bauhaus</option>
                    <option>Pixel Art</option>
                    <option>Concept Art</option>
                    <option>Ukiyo-e</option>
                    <option>Art Deco</option>
                    <option>Synthwave</option>
                    <option>Low Poly</option>
                    <option>Comic Book Style</option>
                    <option>Cinematic</option>
                    <option>Claymation</option>
                    <option>Isometric</option>
                </select></div>
            <div class="input-group full-width"><label for="infobox-style-selector" data-key="infoboxStyleLabel">Estilo
                    de Recuadros</label><select id="infobox-style-selector">
                    <option value="1"></option>
                    <option value="2"></option>
                    <option value="3"></option>
                    <option value="4"></option>
                    <option value="5"></option>
                    <option value="6"></option>
                    <option value="7"></option>
                    <option value="8"></option>
                    <option value="9"></option>
                    <option value="10"></option>
                </select></div>
            <div id="chapter-titles-container" class="full-width"></div>
            <button id="generate-btn" class="full-width" data-key="createBookButton">‚ú® Crear Libro</button>
        </div>
    </div>

    <div id="loader">
        <div class="spinner"></div>
        <p id="loading-status"></p>
    </div>

    <div id="book-wrapper">
        <div id="book-container">
            <nav id="top-nav">
                <div class="nav-group"><button id="pdf-btn" data-key="downloadPDF">Descargar PDF</button><button
                        id="html-btn-nav" data-key="downloadHTML">Descargar HTML</button></div>
                <div class="nav-group" id="goto-group"><input type="number" id="page-input"
                        data-key="pageInputPlaceholder" placeholder="P√°g." min="1"><button id="goto-btn"
                        data-key="gotoButton">Ir</button></div>
                <div class="nav-group"><button id="prev-btn-top">&#9664;</button><span
                        id="page-number-top"></span><button id="next-btn-top">&#9654;</button></div>
                <button class="creator-btn" id="start-over-btn" data-key="createAnotherButton">‚úèÔ∏è Crear Otro</button>
            </nav>
            <div class="book" id="book-element"></div>
            <nav id="bottom-nav">
                <div style="flex:1;"></div>
                <div class="nav-group" style="flex:1; justify-content:center;"><button id="prev-btn-bottom"
                        data-key="prevButton">Anterior</button><span id="page-number-bottom"></span><button
                        id="next-btn-bottom" data-key="nextButton">Siguiente</button></div>
                <div style="flex:1;"></div>
            </nav>
        </div>
    </div>

    <footer data-key="designerCredit">Dise√±ado por Juan Guillermo Rivera Berr√≠o con tecnolog√≠a Gemini 2.5 Pro y las API
        de Pollinations</footer>

    <script>
        const configContainer = document.getElementById('config-container'), loader = document.getElementById('loader'), bookContainer = document.getElementById('book-container'), generateBtn = document.getElementById('generate-btn'), bookTitleInput = document.getElementById('book-title-input'), modelSelector = document.getElementById('model-selector'), styleSelector = document.getElementById('style-selector'), languageSelector = document.getElementById('language-selector'), imageModelSelector = document.getElementById('image-model-selector'), paletteSelector = document.getElementById('palette-selector'), infoboxStyleSelector = document.getElementById('infobox-style-selector'), bookElement = document.getElementById('book-element'), loadingStatus = document.getElementById('loading-status'), pageInput = document.getElementById('page-input'), chapterCountSelector = document.getElementById('chapter-count-selector'), chapterTitlesContainer = document.getElementById('chapter-titles-container'), apiKeyInput = document.getElementById('api-key-input'), getApiKeyBtn = document.getElementById('get-api-key-btn'), pageNavControls = { topNum: document.getElementById('page-number-top'), bottomNum: document.getElementById('page-number-bottom'), topPrev: document.getElementById('prev-btn-top'), bottomPrev: document.getElementById('prev-btn-bottom'), topNext: document.getElementById('next-btn-top'), bottomNext: document.getElementById('next-btn-bottom') };
        let spreads = [], totalSpreads = 0, currentSpreadIndex = 0;

        const translations = {
            es: { appName: "Dise√±ador de Libros Digitales PRO", appDescription: "Elige un tema, idioma, modelo de IA, paleta de colores y estilo visual. La IA escribir√°, ilustrar√° y maquetar√° un libro completo para ti.", apiKeyLabel: "API Key de Pollinations", apiKeyPlaceholder: "plln_sk_...", getApiKeyButton: "üîë Obtener API Key", apiKeyRequired: "Por favor, ingrese su API Key de Pollinations.", apiKeySuccess: "‚úÖ API Key obtenida con √©xito", bookTitleLabel: "T√≠tulo del Libro", bookTitlePlaceholder: "Ej: La historia de los videojuegos", chapterCountLabel: "N√∫mero de Cap√≠tulos", chapterTitleLabel: (c) => `T√≠tulo del Cap√≠tulo ${c}`, chapterTitlePlaceholder: "Ingrese el t√≠tulo aqu√≠", languageLabel: "Idioma", modelTextLabel: "Modelo de Texto", modelImageLabel: "Modelo de Imagen", paletteLabel: "Paleta de Colores", artStyleLabel: "Estilo Art√≠stico", infoboxStyleLabel: "Estilo de Recuadros", createBookButton: "‚ú® Crear Libro", loadingInitial: "Forjando ideas...", step1: "Paso 1: Dise√±ando la estructura...", step2: (c, t) => `Paso 2: Escribiendo cap√≠tulo ${c}/${t}...`, step3: (c, t) => `Paso 3: Maquetando cap√≠tulo ${c}/${t}...`, errorMsg: (m) => `Error: ${m}. Int√©ntalo de nuevo.`, titlesRequired: "Por favor, ingrese un t√≠tulo para el libro y para todos los cap√≠tulos.", downloadPDF: "Descargar PDF", downloadHTML: "Descargar HTML", pageInputPlaceholder: "P√°g.", gotoButton: "Ir", prevButton: "Anterior", nextButton: "Siguiente", createAnotherButton: "‚úèÔ∏è Crear Otro", invalidPageNum: "N√∫mero de p√°gina inv√°lido.", regenerateButton: "Regenerar", deleteButton: "Eliminar", youtubeButton: "YouTube", odyseeButton: "Odysee", urlImageButton: "URL Imagen", youtubePrompt: "Ingrese la URL completa del video de YouTube:", odyseePrompt: "Ingrese la URL completa del video de Odysee:", urlImagePrompt: "Ingrese la URL de la imagen:", youtubeInvalid: "La URL de YouTube no parece ser v√°lida.", odyseeInvalid: "La URL de Odysee no parece ser v√°lida.", urlImageInvalid: "La URL de la imagen no parece ser v√°lida.", coverSubtitle: "Un viaje interactivo", backCoverText: "Libro generado din√°micamente.", endText: "FIN", pdfError: "Error al generar el PDF.", pdfProcessingPage: (c, t) => `Procesando p√°gina ${c}/${t}...`, designerCredit: "Dise√±ado por Juan Guillermo Rivera Berr√≠o con tecnolog√≠a Gemini 2.5 Pro y las API de Pollinations", paletteOptions: ["Cl√°sico", "Crep√∫sculo", "Oc√©ano", "Bosque", "Manuscrito", "Vino", "Retro", "Grafito", "Tierra", "Ne√≥n Nocturno"], infoboxOptions: ["L√≠nea Lateral", "Borde Sutil", "Invertido", "Punteado", "Doble L√≠nea", "Cita", "Sombreado", "Doble Borde", "Nota Adhesiva", "Minimalista Superior"] },
            en: { appName: "Digital Book Designer PRO", appDescription: "Choose a theme, language, AI model, color palette, and visual style. The AI will write, illustrate, and layout a complete book for you.", apiKeyLabel: "Pollinations API Key", apiKeyPlaceholder: "plln_sk_...", getApiKeyButton: "üîë Get API Key", apiKeyRequired: "Please enter your Pollinations API Key.", apiKeySuccess: "‚úÖ API Key obtained successfully", bookTitleLabel: "Book Title", bookTitlePlaceholder: "Ex: The history of video games", chapterCountLabel: "Number of Chapters", chapterTitleLabel: (c) => `Chapter ${c} Title`, chapterTitlePlaceholder: "Enter title here", languageLabel: "Language", modelTextLabel: "Text Model", modelImageLabel: "Image Model", paletteLabel: "Color Palette", artStyleLabel: "Artistic Style", infoboxStyleLabel: "Infobox Style", createBookButton: "‚ú® Create Book", loadingInitial: "Forging ideas...", step1: "Step 1: Designing the structure...", step2: (c, t) => `Step 2: Writing chapter ${c}/${t}...`, step3: (c, t) => `Step 3: Laying out chapter ${c}/${t}...`, errorMsg: (m) => `Error: ${m}. Please try again.`, titlesRequired: "Please enter a title for the book and for all chapters.", downloadPDF: "Download PDF", downloadHTML: "Download HTML", pageInputPlaceholder: "Page", gotoButton: "Go", prevButton: "Previous", nextButton: "Next", createAnotherButton: "‚úèÔ∏è Create Another", invalidPageNum: "Invalid page number.", regenerateButton: "Regenerate", deleteButton: "Delete", youtubeButton: "YouTube", odyseeButton: "Odysee", urlImageButton: "URL Image", youtubePrompt: "Please enter the full YouTube video URL:", odyseePrompt: "Please enter the full Odysee video URL:", urlImagePrompt: "Please enter the image URL:", youtubeInvalid: "The YouTube URL does not appear to be valid.", odyseeInvalid: "The Odysee URL does not appear to be valid.", urlImageInvalid: "The image URL does not appear to be valid.", coverSubtitle: "An interactive journey", backCoverText: "Dynamically generated book.", endText: "THE END", pdfError: "Error generating PDF.", pdfProcessingPage: (c, t) => `Processing page ${c}/${t}...`, designerCredit: "Designed by Juan Guillermo Rivera Berr√≠o with Gemini 2.5 Pro and Pollinations APIs", paletteOptions: ["Classic", "Dusk", "Ocean", "Forest", "Manuscript", "Wine", "Retro", "Graphite", "Earth", "Neon Night"], infoboxOptions: ["Sidebar Line", "Subtle Border", "Inverted", "Dotted", "Double Line", "Quote", "Shaded", "Double Border", "Sticky Note", "Minimalist Top"] },
        };

        const prompts = {
            'es': { langInstruction: 'Responde SOLAMENTE EN ESPA√ëOL. IGNORA cualquier otra instrucci√≥n de idioma.', content: (t, title) => `Escribe un cap√≠tulo sobre "${t}", titulado "${title}". Inserta recuadros informativos con el formato [INFOBOX: T√≠tulo del recuadro | Texto del recuadro]. No incluyas la palabra 'Contenido' en el texto. Sugiere im√°genes usando el formato [IMAGE: Descripci√≥n en ingl√©s para la IA | Descripci√≥n en espa√±ol para el pie de foto]. M√≠nimo 5 p√°rrafos.`, coverImage: (t) => `Respond IN ENGLISH ONLY. Describe in 5-10 English words an epic cover image for a book about "${t}"` },
            'en': { langInstruction: 'Respond ONLY IN ENGLISH. IGNORE any other language instruction.', content: (t, title) => `Write a chapter about "${t}", titled "${title}". Insert info boxes using [INFOBOX: Box Title | Box Text]. Do not include the word 'Content' in the text. Suggest images using the format [IMAGE: English description for the AI | English description for the caption]. Minimum 5 paragraphs.`, coverImage: (t) => `Describe in 5-10 English words an epic cover image for a book about "${t}"` },
        };

        function applyTheme() { document.documentElement.dataset.theme = paletteSelector.value; }
        function applyLanguage() { const c = languageSelector.value, t = translations[c] || translations.es; document.documentElement.lang = c; document.querySelectorAll('[data-key]').forEach(e => { const k = e.dataset.key; if (t[k]) { if (e.tagName === 'INPUT') e.placeholder = t[k]; else e.textContent = t[k]; } }); const updateSelectOptions = (selectorId, optionsArray) => { const select = document.getElementById(selectorId); if (select && optionsArray) { optionsArray.forEach((text, index) => { if (select.options[index]) select.options[index].textContent = text; }); } }; updateSelectOptions('palette-selector', t.paletteOptions); updateSelectOptions('infobox-style-selector', t.infoboxOptions); loadingStatus.textContent = t.loadingInitial; document.title = t.appName; updateChapterInputs(); }

        paletteSelector.addEventListener('change', applyTheme);
        languageSelector.addEventListener('change', applyLanguage);
        chapterCountSelector.addEventListener('change', updateChapterInputs);

        function setupNavEvents() { [pageNavControls.topPrev, pageNavControls.bottomPrev].forEach(b => b.addEventListener('click', prevPage));[pageNavControls.topNext, pageNavControls.bottomNext].forEach(b => b.addEventListener('click', nextPage)); document.getElementById('pdf-btn').addEventListener('click', downloadPDF); document.getElementById('html-btn-nav').addEventListener('click', downloadHTML); document.getElementById('start-over-btn').addEventListener('click', startOver); document.getElementById('goto-btn').addEventListener('click', goToPage); pageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') goToPage(); }); document.addEventListener('keydown', (e) => { if (bookContainer.style.display === 'flex') { if (e.key === 'ArrowRight') nextPage(); else if (e.key === 'ArrowLeft') prevPage(); } }); }
        setupNavEvents();

        generateBtn.addEventListener('click', generateBook);
        bookTitleInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') generateBtn.click(); });

        bookElement.addEventListener('click', function (event) {
            const t = event.target;
            if (t.classList.contains('resize-btn')) resizeImage(t);
            else if (t.classList.contains('regenerate-btn')) regenerateImage(t);
            else if (t.classList.contains('url-image-btn')) insertImageFromURL(t);
            else if (t.classList.contains('youtube-btn')) insertYouTubeVideo(t);
            else if (t.classList.contains('odysee-btn')) insertOdyseeVideo(t);
            else if (t.classList.contains('delete-btn')) deleteImage(t);
        });

        // BYOP: Capturar API Key desde URL hash
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar API Key desde localStorage si existe
            const savedApiKey = localStorage.getItem('pollinations_api_key');
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
            }

            // Capturar API Key desde hash de URL
            const hashParams = new URLSearchParams(window.location.hash.slice(1));
            const apiKey = hashParams.get('api_key');

            if (apiKey) {
                // Guardar en el input
                apiKeyInput.value = apiKey;

                // Persistir para futuras sesiones
                localStorage.setItem('pollinations_api_key', apiKey);

                // Limpiar la URL (Est√©tica y Seguridad)
                window.history.replaceState(null, null, window.location.pathname + window.location.search);

                // Notificar al usuario
                const lang = languageSelector.value;
                const currentTranslations = translations[lang] || translations.es;
                alert(currentTranslations.apiKeySuccess);
            }

            applyLanguage();
        });

        // BYOP: Funci√≥n para iniciar el flujo de autorizaci√≥n
        function startAuthFlow() {
            const redirectUrl = window.location.href.split('#')[0];
            window.location.href = `https://enter.pollinations.ai/authorize?redirect_url=${encodeURIComponent(redirectUrl)}`;
        }

        // BYOP: Event listener para el bot√≥n de obtener API Key
        getApiKeyBtn.addEventListener('click', startAuthFlow);

        function updateChapterInputs() {
            const count = parseInt(chapterCountSelector.value, 10);
            const lang = languageSelector.value;
            const currentTranslations = translations[lang] || translations.es;
            chapterTitlesContainer.innerHTML = '';
            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = '1fr 1fr';
            grid.style.gap = '20px';
            grid.style.width = '100%';
            for (let i = 1; i <= count; i++) {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';
                if ((count === 3 && i === 3) || (count === 5 && i === 5)) { inputGroup.style.gridColumn = '1 / -1'; }
                const label = document.createElement('label');
                label.textContent = currentTranslations.chapterTitleLabel(i);
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'chapter-title-input';
                input.placeholder = currentTranslations.chapterTitlePlaceholder;
                inputGroup.appendChild(label);
                inputGroup.appendChild(input);
                grid.appendChild(inputGroup);
            }
            chapterTitlesContainer.appendChild(grid);
        }

        async function generateBook() {
            const bookTitle = bookTitleInput.value.trim();
            const chapterTitleInputs = chapterTitlesContainer.querySelectorAll('.chapter-title-input');
            const chapterTitles = Array.from(chapterTitleInputs).map(input => input.value.trim());
            const textModel = modelSelector.value;
            const lang = languageSelector.value;
            const currentTranslations = translations[lang] || translations.es;
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                alert(currentTranslations.apiKeyRequired);
                return;
            }

            if (!bookTitle || chapterTitles.some(title => title === '')) {
                alert(currentTranslations.titlesRequired);
                return;
            }

            // Guardar API Key en localStorage
            localStorage.setItem('pollinations_api_key', apiKey);

            applyTheme(); configContainer.style.display = 'none'; loader.style.display = 'flex'; bookElement.innerHTML = '';

            try {
                const langPrompts = prompts[lang] || prompts.es;
                loadingStatus.textContent = currentTranslations.step1;
                await createCover(bookTitle, textModel, lang);
                for (let i = 0; i < chapterTitles.length; i++) {
                    loadingStatus.textContent = currentTranslations.step2(i + 1, chapterTitles.length);
                    const chapterText = await fetchApi(`${langPrompts.langInstruction} ${langPrompts.content(bookTitle, chapterTitles[i])}`, textModel);
                    loadingStatus.textContent = currentTranslations.step3(i + 1, chapterTitles.length);
                    await processAndPaginateChapter(chapterTitles[i], chapterText);
                }
                createBackCover(lang);
                spreads = bookElement.querySelectorAll('.spread'); totalSpreads = spreads.length;
                pageInput.max = (totalSpreads - 2) * 2 + 1;

                document.body.style.overflow = 'hidden';
                document.body.style.height = '100vh';

                showSpread(0); loader.style.display = 'none'; bookContainer.style.display = 'flex';
            } catch (error) { console.error('Error:', error); loadingStatus.textContent = currentTranslations.errorMsg(error.message); setTimeout(() => { loader.style.display = 'none'; configContainer.style.display = 'flex'; }, 5000); }
        }

        async function fetchApi(prompt, model) {
            const apiKey = apiKeyInput.value.trim();
            const r = await fetch(`https://enter.pollinations.ai/api/generate/text/${encodeURIComponent(prompt)}?key=${apiKey}&model=${model}`);
            if (!r.ok) throw new Error(`IA fall√≥ (status ${r.status})`);
            return await r.text();
        }

        function generateSingleImage(englishPrompt, style, imageModel) {
            const apiKey = apiKeyInput.value.trim();
            const seed = Math.floor(Math.random() * 10000);
            return `https://enter.pollinations.ai/api/generate/image/${encodeURIComponent(englishPrompt + ", " + style)}?key=${apiKey}&width=800&height=400&seed=${seed}&model=${imageModel}`;
        }

        async function generateImageWithRetries(englishPrompt, style, imageModel, maxAttempts = 5) {
            const apiKey = apiKeyInput.value.trim();
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                try {
                    const seed = Math.floor(Math.random() * 10000) + (attempt * 1000);
                    const imageUrl = `https://enter.pollinations.ai/api/generate/image/${encodeURIComponent(englishPrompt + ", " + style)}?key=${apiKey}&width=800&height=400&seed=${seed}&model=${imageModel}`;

                    // Probar cargando la imagen directamente
                    const testImg = new Image();

                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => reject(new Error('Timeout')), 15000); // 15 segundos

                        testImg.onload = () => {
                            clearTimeout(timeout);
                            resolve();
                        };

                        testImg.onerror = () => {
                            clearTimeout(timeout);
                            reject(new Error('Image load failed'));
                        };

                        testImg.src = imageUrl;
                    });

                    // Si llegamos aqu√≠, la imagen se carg√≥ correctamente
                    return imageUrl;

                } catch (error) {
                    console.log(`Intento ${attempt} de regeneraci√≥n fall√≥:`, error.message);
                    if (attempt === maxAttempts) {
                        throw new Error('No se pudo generar la imagen despu√©s de m√∫ltiples intentos');
                    }
                    // Esperar un poco antes del siguiente intento
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }

        function createImageContainerHTML(englishPrompt, captionText, style, altText, imageModel) {
            const lang = languageSelector.value;
            const currentTranslations = translations[lang] || translations.es;

            // Generar imagen con un solo intento (como antes)
            const imageUrl = generateSingleImage(englishPrompt, style, imageModel);

            return `<figure class="image-container">
                    <img src="${imageUrl}" alt="${altText}" onerror="this.style.border='2px solid #ff6b6b'; this.style.background='#ffe6e6'; this.alt='Error al cargar imagen - Use Regenerar o URL Imagen';">
                    <figcaption>${captionText}</figcaption>
                    <div class="image-resizer"><button class="resize-btn" data-direction="increase">‚ñ≤</button><button class="resize-btn" data-direction="decrease">‚ñº</button></div>
                    <div class="image-controls">
                        <input type="text" class="prompt-input" value="${englishPrompt}">
                        <button class="regenerate-btn" data-style="${style}" data-image-model="${imageModel}">${currentTranslations.regenerateButton}</button>
                        <button class="url-image-btn">${currentTranslations.urlImageButton}</button>
                        <button class="youtube-btn">${currentTranslations.youtubeButton}</button>
                        <button class="odysee-btn">${currentTranslations.odyseeButton}</button>
                        <button class="delete-btn">${currentTranslations.deleteButton}</button>
                    </div>
                </figure>`;
        }

        async function processAndPaginateChapter(title, content) {
            const cleanedContent = content.replace(/(imagen sugerida|suggested image|image suggestion|sugerencia de imagen):?\s*/gi, '');
            const elements = parseContent(cleanedContent);
            let pageHTML = `<h2>${title}</h2>`;
            for (const element of elements) {
                const tempHTML = pageHTML + element;
                if (await isContentOverflowing(tempHTML)) {
                    addPageToBook(pageHTML);
                    pageHTML = element;
                } else { pageHTML = tempHTML; }
            }
            addPageToBook(pageHTML);
        }

        function parseContent(content) {
            const style = styleSelector.value, imageModel = imageModelSelector.value, infoboxStyle = `info-box-style-${infoboxStyleSelector.value}`, elements = [];
            const regex = /(\[INFOBOX:.+?\]|\[IMAGE:.+?\])/g;
            content.split(regex).filter(p => p.trim() !== '').forEach(part => {
                if (part.startsWith('[INFOBOX:')) {
                    const [title, ...boxContent] = part.slice(10, -1).split('|');
                    elements.push(`<aside class="info-box ${infoboxStyle}"><h3>${title.trim()}</h3><p>${boxContent.join('|').trim()}</p></aside>`);
                } else if (part.startsWith('[IMAGE:')) {
                    const innerContent = part.slice(8, -1).trim();
                    const parts = innerContent.split('|');
                    const englishPrompt = parts[0].trim();
                    const captionText = (parts.length > 1 ? parts[1].trim() : englishPrompt);
                    elements.push(createImageContainerHTML(englishPrompt, captionText, style, englishPrompt, imageModel));
                } else { part.split('\n').filter(p => p.trim() !== '').forEach(p => elements.push(`<p>${p}</p>`)); }
            });
            return elements;
        }

        function isContentOverflowing(html) { return new Promise(resolve => { const t = document.createElement('div'); t.style.cssText = `position: absolute; visibility: hidden; width: var(--page-width); height: 78vh;`; t.innerHTML = `<div class="page-content">${html}</div>`; document.body.appendChild(t); requestAnimationFrame(() => { resolve(t.querySelector('.page-content').scrollHeight > t.querySelector('.page-content').clientHeight); document.body.removeChild(t); }); }); }
        function addPageToBook(html) { const p = `<div class="page-content">${html}</div>`; const l = bookElement.lastElementChild; if (!l || l.querySelector('.right').innerHTML !== '') { const n = document.createElement('div'); n.className = 'spread'; n.innerHTML = `<div class="page left">${p}</div><div class="page right"></div>`; bookElement.appendChild(n); } else { l.querySelector('.right').innerHTML = p; } }
        async function createCover(theme, textModel, lang) { const t = translations[lang] || translations.es; const title = theme.charAt(0).toUpperCase() + theme.slice(1); const prompt = await fetchApi((prompts[lang] || prompts.es).coverImage(theme), textModel); const style = styleSelector.value, imageModel = imageModelSelector.value; const imgHTML = createImageContainerHTML(prompt.trim(), title, style, "Portada", imageModel); const s = document.createElement('div'); s.className = 'spread'; s.innerHTML = `<div class="page blank"></div><div class="page right"><div class="page-content cover"><h1>${title}</h1>${imgHTML}<p>${t.coverSubtitle}</p></div></div>`; bookElement.appendChild(s); }
        function createBackCover(lang) { const t = translations[lang] || translations.es; const c = `<div class="page-content cover"><h2>${t.endText}</h2><p>${t.backCoverText}</p></div>`; addPageToBook(c); const l = bookElement.lastElementChild; if (l.querySelector('.right').innerHTML === '') l.querySelector('.right').classList.add('blank'); }

        function showSpread(index) { currentSpreadIndex = index; spreads.forEach((s, i) => s.classList.toggle('active', i === index)); spreads.forEach(s => s.classList.remove('show-right')); updateNav(); }

        function updateNav() {
            const isPortrait = window.matchMedia("(orientation: portrait)").matches;
            if (isPortrait) {
                const activeSpread = spreads[currentSpreadIndex];
                const isRightPage = activeSpread && activeSpread.classList.contains('show-right');
                let pageText = '', pageNum = 0;
                if (currentSpreadIndex === 0) { pageText = 'Portada'; }
                else {
                    pageNum = isRightPage ? currentSpreadIndex * 2 : currentSpreadIndex * 2 - 1;
                    pageText = `P√°g ${pageNum}`;
                    if (currentSpreadIndex === totalSpreads - 1) { pageText = isRightPage ? 'Contraportada' : pageText; }
                }
                [pageNavControls.topNum, pageNavControls.bottomNum].forEach(el => el.textContent = pageText);
                const isFirstPage = currentSpreadIndex === 0;
                const lastPageContent = spreads[totalSpreads - 1].querySelector('.right').innerHTML;
                const isLastPage = currentSpreadIndex === totalSpreads - 1 && (isRightPage || lastPageContent === '');
                [pageNavControls.topPrev, pageNavControls.bottomPrev].forEach(b => b.disabled = isFirstPage && !isRightPage);
                [pageNavControls.topNext, pageNavControls.bottomNext].forEach(b => b.disabled = isLastPage);
            } else {
                let l = '', r = '';
                if (currentSpreadIndex === 0) r = 'Portada';
                else if (currentSpreadIndex === totalSpreads - 1) l = 'Contraportada';
                else { l = currentSpreadIndex * 2 - 1; r = currentSpreadIndex * 2; }
                const pageText = (l && r) ? `P√°gs ${l}-${r}` : (l || r);
                [pageNavControls.topNum, pageNavControls.bottomNum].forEach(el => el.textContent = pageText);
                [pageNavControls.topPrev, pageNavControls.bottomPrev].forEach(b => b.disabled = currentSpreadIndex === 0);
                [pageNavControls.topNext, pageNavControls.bottomNext].forEach(b => b.disabled = currentSpreadIndex === totalSpreads - 1);
            }
        }

        function nextPage() {
            const isPortrait = window.matchMedia("(orientation: portrait)").matches;
            if (isPortrait && spreads.length > 0) {
                const activeSpread = spreads[currentSpreadIndex];
                const hasRightContent = activeSpread.querySelector('.right').innerHTML.trim() !== '' && !activeSpread.querySelector('.right').classList.contains('blank');
                if (!activeSpread.classList.contains('show-right') && hasRightContent) { activeSpread.classList.add('show-right'); updateNav(); }
                else if (currentSpreadIndex < totalSpreads - 1) { showSpread(currentSpreadIndex + 1); }
            } else if (currentSpreadIndex < totalSpreads - 1) { showSpread(currentSpreadIndex + 1); }
        }

        function prevPage() {
            const isPortrait = window.matchMedia("(orientation: portrait)").matches;
            if (isPortrait && spreads.length > 0) {
                const activeSpread = spreads[currentSpreadIndex];
                if (activeSpread.classList.contains('show-right')) { activeSpread.classList.remove('show-right'); updateNav(); }
                else if (currentSpreadIndex > 0) {
                    const prevSpread = spreads[currentSpreadIndex - 1];
                    const hasRightContent = prevSpread.querySelector('.right').innerHTML.trim() !== '' && !prevSpread.querySelector('.right').classList.contains('blank');
                    showSpread(currentSpreadIndex - 1);
                    if (hasRightContent) { spreads[currentSpreadIndex].classList.add('show-right'); updateNav(); }
                }
            } else if (currentSpreadIndex > 0) { showSpread(currentSpreadIndex - 1); }
        }

        function goToPage() {
            const pageNum = parseInt(pageInput.value);
            const lang = languageSelector.value;
            const currentTranslations = translations[lang] || translations.es;
            const isPortrait = window.matchMedia("(orientation: portrait)").matches;
            if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= (totalSpreads - 2) * 2 + 1) {
                const targetSpread = Math.ceil(pageNum / 2);
                showSpread(targetSpread);
                if (isPortrait && pageNum % 2 === 0) { spreads[currentSpreadIndex].classList.add('show-right'); updateNav(); }
            } else { alert(currentTranslations.invalidPageNum); pageInput.value = ''; }
        }

        function startOver() { location.reload(); }
        async function regenerateImage(btn) {
            const c = btn.closest('.image-container'), img = c.querySelector('img'), p = c.querySelector('.prompt-input').value, s = btn.dataset.style, m = btn.dataset.imageModel;
            const currentTranslations = translations[languageSelector.value] || translations.es;

            img.style.opacity = '0.5';
            btn.disabled = true;
            btn.textContent = 'Generando...';

            try {
                const newUrl = await generateImageWithRetries(p, s, m);
                img.src = newUrl;
                img.style.opacity = '1';
            } catch (error) {
                img.style.opacity = '1';
                alert(currentTranslations.errorMsg('No se pudo generar la imagen'));
            } finally {
                btn.disabled = false;
                btn.textContent = currentTranslations.regenerateButton;
            }
        }
        function deleteImage(btn) { btn.closest('figure.image-container').remove(); }
        function resizeImage(btn) {
            const isIncrease = btn.dataset.direction === 'increase';
            const container = btn.closest('.image-container');
            if (!container) return;

            console.log('Resizing image:', isIncrease ? 'increase' : 'decrease');

            // Verificar si estamos en la portada
            const isCover = container.closest('.cover') !== null;

            // Obtener el aspect ratio actual o usar el por defecto
            const currentRatio = container.style.aspectRatio || '800 / 400';
            const ratioParts = currentRatio.split(' / ');
            const currentHeight = parseFloat(ratioParts[1]);

            // Calcular nueva altura
            const delta = isIncrease ? -20 : 20;
            let newHeight = currentHeight + delta;

            // Aplicar l√≠mites
            if (newHeight < 200) newHeight = 200;
            if (newHeight > 600) newHeight = 600;

            // Aplicar el nuevo aspect ratio
            container.style.aspectRatio = `800 / ${newHeight}`;

            // Para la portada, forzar tambi√©n el estilo height
            if (isCover) {
                const containerWidth = container.offsetWidth;
                const calculatedHeight = (containerWidth * newHeight) / 800;
                container.style.height = `${calculatedHeight}px`;
                container.style.minHeight = `${calculatedHeight}px`;
                container.style.maxHeight = `${calculatedHeight}px`;
            } else {
                // Fallback para navegadores que no soportan aspect-ratio
                const containerWidth = container.offsetWidth;
                const calculatedHeight = (containerWidth * newHeight) / 800;
                container.style.height = `${calculatedHeight}px`;
            }

            // Forzar un reflow para asegurar que el cambio se aplique
            container.offsetHeight;

            console.log('New aspect ratio:', `800 / ${newHeight}`, 'Is cover:', isCover);
        }
        function extractYouTubeId(url) { const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/; const match = url.match(regex); return match ? match[1] : null; }

        function extractOdyseeEmbedUrl(url) {
            // Extraer informaci√≥n de la URL de Odysee para crear el embed
            const regex = /(?:https?:\/\/)?(?:www\.)?odysee\.com\/([^\/]+)\/([^\/\?]+)/;
            const match = url.match(regex);
            if (match) {
                const channel = match[1];
                const video = match[2];
                return `https://odysee.com/$/embed/${channel}/${video}`;
            }
            return null;
        }

        function insertYouTubeVideo(btn) { const lang = languageSelector.value; const currentTranslations = translations[lang] || translations.es; const url = prompt(currentTranslations.youtubePrompt); if (!url) return; const videoId = extractYouTubeId(url); if (videoId) { const container = btn.closest('.image-container'); container.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`; } else { alert(currentTranslations.youtubeInvalid); } }

        function insertOdyseeVideo(btn) {
            const lang = languageSelector.value;
            const currentTranslations = translations[lang] || translations.es;
            const url = prompt(currentTranslations.odyseePrompt);
            if (!url) return;

            // Si el usuario proporciona directamente una URL de embed, usarla
            if (url.includes('$/embed/')) {
                const container = btn.closest('.image-container');
                container.innerHTML = `<iframe id="odysee-iframe" style="width:100%; aspect-ratio:16 / 9;" src="${url}" allowfullscreen></iframe>`;
            } else {
                // Intentar extraer la informaci√≥n para crear el embed
                const embedUrl = extractOdyseeEmbedUrl(url);
                if (embedUrl) {
                    const container = btn.closest('.image-container');
                    container.innerHTML = `<iframe id="odysee-iframe" style="width:100%; aspect-ratio:16 / 9;" src="${embedUrl}" allowfullscreen></iframe>`;
                } else {
                    alert(currentTranslations.odyseeInvalid);
                }
            }
        }

        function insertImageFromURL(btn) {
            const lang = languageSelector.value;
            const currentTranslations = translations[lang] || translations.es;
            const url = prompt(currentTranslations.urlImagePrompt);
            if (!url) return;

            // Validaci√≥n m√°s permisiva - solo verificar que sea una URL v√°lida
            try {
                new URL(url); // Esto lanza error si no es una URL v√°lida

                const container = btn.closest('.image-container');
                const img = container.querySelector('img');
                const figcaption = container.querySelector('figcaption');

                // Actualizar la imagen
                img.src = url;

                // Actualizar el prompt input para reflejar que es una URL personalizada
                const promptInput = container.querySelector('.prompt-input');
                promptInput.value = 'Imagen personalizada desde URL';

                // Opcional: Actualizar el caption si el usuario quiere
                const newCaption = prompt('Ingrese una nueva descripci√≥n para la imagen (opcional):', figcaption.textContent);
                if (newCaption && newCaption.trim() !== '') {
                    figcaption.textContent = newCaption.trim();
                }

                // Manejar error de carga de imagen
                img.onerror = function () {
                    alert('No se pudo cargar la imagen desde la URL proporcionada. Verifique que la URL sea correcta y accesible.');
                };

            } catch (error) {
                alert(currentTranslations.urlImageInvalid);
            }
        }

        async function downloadPDF() {
            loader.style.display = 'flex';
            const lang = languageSelector.value;
            const currentTranslations = translations[lang] || translations.es;
            const originalActiveSpread = currentSpreadIndex;
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
                const allPages = Array.from(bookElement.querySelectorAll('.page:not(.blank)'));
                spreads.forEach(s => s.style.display = 'none');
                for (let i = 0; i < allPages.length; i++) {
                    loadingStatus.textContent = currentTranslations.pdfProcessingPage(i + 1, allPages.length);
                    const page = allPages[i];
                    page.querySelectorAll('.image-controls, .image-resizer').forEach(el => el.style.display = 'none');

                    const iframes = Array.from(page.querySelectorAll('iframe'));
                    const restoredElements = new Map();
                    iframes.forEach(iframe => {
                        const videoId = extractYouTubeId(iframe.src);
                        const isOdysee = iframe.src.includes('odysee.com');

                        if (videoId) {
                            const placeholder = document.createElement('div');
                            placeholder.style.cssText = `width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; background-color:#111; color:var(--book-bg); text-align:center; padding: 1em; box-sizing: border-box; font-family: sans-serif;`;
                            placeholder.innerHTML = `<p style="font-weight: bold; font-size: 1.2em; margin:0 0 1em 0;">‚ñ∂Ô∏è YouTube Video</p><img src="https://i.ytimg.com/vi/${videoId}/mqdefault.jpg" style="max-width:80%; border:1px solid var(--secondary-color); margin-bottom: 1em;" crossorigin="anonymous"><p style="margin:0; font-size:0.9em; word-break: break-all;">https://youtu.be/${videoId}</p>`;
                            restoredElements.set(placeholder, iframe);
                            iframe.parentNode.replaceChild(placeholder, iframe);
                        } else if (isOdysee) {
                            const placeholder = document.createElement('div');
                            placeholder.style.cssText = `width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; background-color:#1a73e8; color:white; text-align:center; padding: 1em; box-sizing: border-box; font-family: sans-serif;`;
                            placeholder.innerHTML = `<p style="font-weight: bold; font-size: 1.2em; margin:0 0 1em 0;">‚ñ∂Ô∏è Odysee Video</p><div style="width:80%; height:120px; background-color:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.3); margin-bottom: 1em; display:flex; align-items:center; justify-content:center; font-size:3em;">üé¨</div><p style="margin:0; font-size:0.9em; word-break: break-all;">${iframe.src}</p>`;
                            restoredElements.set(placeholder, iframe);
                            iframe.parentNode.replaceChild(placeholder, iframe);
                        }
                    });

                    page.parentElement.style.display = 'flex';
                    page.style.display = 'block';
                    const images = Array.from(page.querySelectorAll('img'));
                    const promises = images.map(img => new Promise(resolve => {
                        if (img.complete && img.naturalHeight !== 0) return resolve();
                        const timer = setTimeout(resolve, 4000);
                        img.onload = () => { clearTimeout(timer); resolve(); };
                        img.onerror = () => { clearTimeout(timer); resolve(); };
                    }));
                    await Promise.all(promises);
                    await new Promise(resolve => setTimeout(resolve, 200));
                    const canvas = await html2canvas(page, { scale: 2, useCORS: true });
                    const pdfWidth = pdf.internal.pageSize.getWidth(), pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasAspectRatio = canvas.width / canvas.height, pdfAspectRatio = pdfWidth / pdfHeight;
                    let renderWidth, renderHeight;
                    if (canvasAspectRatio > pdfAspectRatio) { renderWidth = pdfWidth; renderHeight = pdfWidth / canvasAspectRatio; } else { renderHeight = pdfHeight; renderWidth = pdfHeight * canvasAspectRatio; }
                    const xOffset = (pdfWidth - renderWidth) / 2;
                    const yOffset = (pdfHeight - renderHeight) / 2;
                    if (i > 0) pdf.addPage();
                    pdf.addImage(canvas.toDataURL('image/jpeg', 0.9), 'JPEG', xOffset, yOffset, renderWidth, renderHeight);

                    restoredElements.forEach((iframe, placeholder) => { if (placeholder.parentNode) { placeholder.parentNode.replaceChild(iframe, placeholder); } });
                    page.parentElement.style.display = 'none';
                    page.style.display = '';
                    page.querySelectorAll('.image-controls, .image-resizer').forEach(el => el.style.display = '');
                }
                pdf.save(`${(bookTitleInput.value.trim() || 'libro-ia').replace(/\s+/g, '_')}.pdf`);
            } catch (error) {
                console.error("Error PDF:", error);
                loadingStatus.textContent = currentTranslations.pdfError;
                setTimeout(() => loader.style.display = 'none', 3000);
            } finally {
                spreads.forEach(s => s.style.display = '');
                showSpread(originalActiveSpread);
                loader.style.display = 'none';
            }
        }

        async function imageToBase64(url) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (e) {
                console.error("Error converting image to Base64:", e);
                return url;
            }
        }
        async function downloadHTML() {
            const lang = languageSelector.value;
            const currentTranslations = translations[lang] || translations.es;

            loader.style.display = 'flex';
            loadingStatus.textContent = currentTranslations.pdfProcessingPage(1, 1);

            const clone = document.documentElement.cloneNode(true);
            clone.dataset.theme = paletteSelector.value;
            clone.lang = lang;

            // Limpiar elementos innecesarios
            const toRemove = ['#config-container', '#loader', '.creator-btn', '#pdf-btn', '#html-btn-nav', 'script'];
            toRemove.forEach(selector => {
                const el = clone.querySelector(selector);
                if (el) el.remove();
            });

            clone.querySelectorAll('.image-controls, .image-resizer').forEach(el => el.remove());
            clone.querySelectorAll('.spread').forEach(s => s.classList.remove('active'));

            const bookClone = clone.querySelector('#book-element');
            if (bookClone) {
                let pageCounter = 1;
                const contentPages = bookClone.querySelectorAll('.page:not(.blank)');
                contentPages.forEach(page => {
                    const parent = page.parentNode;
                    const comment = document.createComment(` P√°gina ${pageCounter} `);
                    const newlineBefore = document.createTextNode('\n\n    ');
                    parent.insertBefore(newlineBefore, page);
                    parent.insertBefore(comment, page);
                    pageCounter++;
                });
                bookClone.querySelectorAll('.spread').forEach(spread => {
                    spread.parentNode.insertBefore(document.createTextNode('\n'), spread.nextSibling);
                });
            }

            const images = Array.from(clone.querySelectorAll('img'));
            for (let i = 0; i < images.length; i++) {
                const img = images[i];
                if (img.src && !img.src.startsWith('data:')) {
                    loadingStatus.textContent = currentTranslations.pdfProcessingPage(i + 1, images.length);
                    img.src = await imageToBase64(img.src);
                }
            }

            const staticScriptContent = `
        document.addEventListener('DOMContentLoaded', function() {
            const bookElement = document.getElementById('book-element');
            const pageInput = document.getElementById('page-input');
            const navControls = { 
                topNum: document.getElementById('page-number-top'), 
                bottomNum: document.getElementById('page-number-bottom'),
                allPrev: document.querySelectorAll('#prev-btn-top, #prev-btn-bottom'),
                allNext: document.querySelectorAll('#next-btn-top, #next-btn-bottom'),
                gotoBtn: document.getElementById('goto-btn')
            };
            let spreads = Array.from(bookElement.querySelectorAll('.spread')), totalSpreads = spreads.length, currentSpreadIndex = 0;
            
            function isPortrait() { return window.matchMedia("(orientation: portrait)").matches; }
            function showSpread(index) { currentSpreadIndex = index; spreads.forEach((s, i) => s.classList.toggle('active', i === index)); spreads.forEach(s => s.classList.remove('show-right')); updateNav(); }
            function updateNav() {
                if (isPortrait()) {
                    const activeSpread = spreads[currentSpreadIndex];
                    const isRightPage = activeSpread && activeSpread.classList.contains('show-right');
                    let pageText = '', pageNum = 0;
                    if (currentSpreadIndex === 0) { pageText = 'Portada'; } 
                    else {
                        pageNum = isRightPage ? currentSpreadIndex * 2 : currentSpreadIndex * 2 - 1;
                        pageText = \`P√°g \${pageNum}\`;
                        if(currentSpreadIndex === totalSpreads - 1) { pageText = isRightPage ? 'Contraportada' : pageText; }
                    }
                    [navControls.topNum, navControls.bottomNum].forEach(el => { if(el) el.textContent = pageText });
                    const isFirstPage = currentSpreadIndex === 0;
                    const lastPageContent = spreads[totalSpreads - 1].querySelector('.right').innerHTML;
                    const isLastPage = currentSpreadIndex === totalSpreads - 1 && (isRightPage || lastPageContent === '');
                    navControls.allPrev.forEach(b => b.disabled = isFirstPage && !isRightPage);
                    navControls.allNext.forEach(b => b.disabled = isLastPage);
                } else {
                    let l = '', r = '';
                    if (currentSpreadIndex === 0) r = 'Portada'; 
                    else if (currentSpreadIndex === totalSpreads - 1) l = 'Contraportada'; 
                    else { l = currentSpreadIndex * 2 - 1; r = currentSpreadIndex * 2; }
                    const pageText = (l && r) ? \`P√°gs \${l}-\${r}\` : (l || r);
                    [navControls.topNum, navControls.bottomNum].forEach(el => { if(el) el.textContent = pageText });
                    navControls.allPrev.forEach(b => b.disabled = currentSpreadIndex === 0);
                    navControls.allNext.forEach(b => b.disabled = currentSpreadIndex === totalSpreads - 1);
                }
            }
            function nextPage() {
                if (isPortrait() && spreads.length > 0) {
                    const activeSpread = spreads[currentSpreadIndex];
                    const hasRightContent = activeSpread.querySelector('.right').innerHTML.trim() !== '' && !activeSpread.querySelector('.right').classList.contains('blank');
                    if (!activeSpread.classList.contains('show-right') && hasRightContent) { activeSpread.classList.add('show-right'); updateNav(); }
                    else if (currentSpreadIndex < totalSpreads - 1) { showSpread(currentSpreadIndex + 1); }
                } else if (currentSpreadIndex < totalSpreads - 1) { showSpread(currentSpreadIndex + 1); }
            }
            function prevPage() {
                if (isPortrait() && spreads.length > 0) {
                    const activeSpread = spreads[currentSpreadIndex];
                    if (activeSpread.classList.contains('show-right')) { activeSpread.classList.remove('show-right'); updateNav(); }
                    else if (currentSpreadIndex > 0) {
                        const prevSpread = spreads[currentSpreadIndex - 1];
                        const hasRightContent = prevSpread.querySelector('.right').innerHTML.trim() !== '' && !prevSpread.querySelector('.right').classList.contains('blank');
                        showSpread(currentSpreadIndex - 1);
                        if (hasRightContent) { spreads[currentSpreadIndex].classList.add('show-right'); updateNav(); }
                    }
                } else if (currentSpreadIndex > 0) { showSpread(currentSpreadIndex - 1); }
            }
            function goToPage() {
                const pageNum = parseInt(pageInput.value);
                const invalidPageMessage = "${currentTranslations.invalidPageNum}";
                if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= (totalSpreads - 2) * 2 + 1) {
                    const targetSpread = Math.ceil(pageNum / 2);
                    showSpread(targetSpread);
                    if(isPortrait() && pageNum % 2 === 0) { spreads[currentSpreadIndex].classList.add('show-right'); updateNav(); }
                } else { alert(invalidPageMessage); pageInput.value = ''; }
            }
            navControls.allPrev.forEach(b => b.addEventListener('click', prevPage));
            navControls.allNext.forEach(b => b.addEventListener('click', nextPage));
            if(navControls.gotoBtn) navControls.gotoBtn.addEventListener('click', goToPage);
            if(pageInput) pageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') goToPage(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'ArrowRight') nextPage(); else if (e.key === 'ArrowLeft') prevPage(); });
            window.addEventListener('resize', updateNav);
            showSpread(0);
        });`;

            const newScriptEl = clone.ownerDocument.createElement('script');
            newScriptEl.textContent = staticScriptContent;
            clone.querySelector('body').appendChild(newScriptEl);
            const blob = new Blob([clone.outerHTML], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${(bookTitleInput.value.trim() || 'libro-ia').replace(/\s+/g, '_')}.html`;
            a.click();
            URL.revokeObjectURL(a.href);
            loader.style.display = 'none';
        }
    </script>
</body>

</html>